<!DOCTYPE html>
<html lang="en">
<head>
    <title>首页</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">

    <link rel="stylesheet" href="../lib/weui.min.css">
    <link rel="stylesheet" href="../lib/weui.css">
    <link rel="stylesheet" href="../css/jquery-weui.css">
    <link rel="stylesheet" href="css/demos.css">
    <link rel="stylesheet" href="../lib/need/layer.css">


    <link rel="stylesheet" href="../lib/weui.order.css">
    <style>
        .title {
            background-image: url(images/shouye1.png);
            width: 100%;
            height: 300px;
            background-repeat: no-repeat;
            /* background: red; */
            background-size: 100% 90%;
            background-color: #FFFFFF;
        }

        .imgage img {
            width: 17px;
            height: 17px;
            filter: drop-shadow(0 0 0 #FFF);
        }

        .imgage {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 92%;
            padding: 0 4%;
            padding-top: 11px;
        }

        .weui-search-bar__form {
            position: relative;
            -webkit-box-flex: 1;
            -webkit-flex: auto;
            flex: auto;
            background-color: #EFEFF4;
            border-radius: 2px;
        }

        .swiper-container {
            overflow: hidden;
            width: 92%;
            margin-top: 17px;
        }

        .swiper-slide {
            height: auto;
			height: 250px;
            overflow: hidden;
			text-align:center;
			background-color: #d4d4d4;
        }

        .swiper-slide img {
            height: 250px;
        }

        .imgage .head {
            width: 22px;
            height: 22px;
        }

        .alarm {
            position: relative;
            width: 17px;
            height: 17px;
        }

        .alarm img {
            width: 17px;
            height: 17px;
        }

        .alarm .right {
            position: absolute;
            color: #FFFFFF;
            font-size: 13px;
            background-color: #Ff0000;
            width: 14px;
            height: 14px;
            line-height: 13px;
            left: 70%;
            top: -8px;
            text-align: center;
            -webkit-border-radius: 50%;
            border-radius: 50%;
        }

        .best {
            width: 92%;
            padding: 0 4%;
            height: auto;
            background-color: #FFFFFF;
            margin-bottom: 48px;
        }

        .biaoti {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 19px;
            color: #000000;
            padding: 30px 0;
        }

        body {
            background-color: #FFFFFF;
        }

        .details {
            width: 100%;
            margin: 0px;
            border-bottom: 1px solid #e5e5e5;
            padding: 4% 0;
        }

        .details .details-left {
            width: 43%;
            height: 43%;
        }

        .details-right .right-name {
            font-size: 16px;
            color: #666666;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .right-price .pric .yuan {
            color: #666666;
            font-size: 17px;
        }

        .right-price .pric .xiao {
            color: #666666;
            font-size: 13px;
        }

        .right-price .pric {
            width: 90%;
        }

        .right-price .num {
            font-size: 14px;
            color: #FFFFFF;
            background: linear-gradient(0deg, rgba(200, 143, 58, 1), rgba(229, 173, 91, 1));
            width: 70px;
            height: 26px;
            border-radius: 13px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .right-price {
            display: flex;
            align-items: center;
        }

        .details-right .right-price {
            padding-top: 15px;
        }

        body {
            background-color: #e5e5e5;
        }

        .refresh {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background-color: #ffffff;
            top: -1px;
            height: 40px;
        }

        .refresh img {
            width: 19px;
            height: 16px;
        }

        .refresh .refresh-tt {
            font-size: 14px;
            color: #C0C0C0;
            padding-left: 6px;
        }

        .recommend {
            width: 96%;
            padding: 0 2%;
            height: auto;
            background-color: #FFFFFF;
            margin-bottom: 50px;
        }

        .list-up {
            width: 100%;
            height: 100%;
        }

        .list-up img {
            width: 100%;
            height: 100%;
        }

        .list-down .down-name {
            font-size: 7px;
            color: #666666;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .list-down .dowan-price {
            font-size: 17px;
            color: #666666;
        }

        .list-down .down-num {
            font-size: 13px;
            color: #666666;
        }

        .list .list-biao {
            border: 1px solid #CCCCCC;
        }

        .price {
            justify-content: space-between;
            align-items: center;
            width: 90%;
            display: flex;
        }

        .list-down {
            width: 96%;
            padding: 0 2%;
        }

        .recommend-list {
            width: 100%;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }

        .recommend-list a {
            width: 46%;
            padding: 2% 2%;
        }

        .cov {
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            position: fixed;
            text-align: center;
            font-size: 16px;
            top: 0;
            left: 0;
            justify-content: center;
            align-items: center;
            display: flex;
        }

        .con {
            z-index: 1100;
            width: 285px;
            height: 285px;
            background-color: white;
            top: 191px;
            position: absolute;
        }

        .ptitle {
            width: 100%;
            height: 180px;
            border-radius: 6px 6px 0 0;
        }

        .ptitle img {
            height: 100%;
            width: 100%;
        }

        .dbt {
            width: 50%;
            height: 45px;
            background-color: #B5B5B5;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .text {
            font-size: 14px;
            color: #666666;
            background-color: #FFFFFF;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .but {
            width: 50%;
            height: 45px;
            background: linear-gradient(0deg, rgba(200, 143, 58, 1), rgba(229, 173, 91, 1));
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .button {
            display: flex;
            justify-content: space-between;
        }

        .button .but a {
            text-decoration: none;
            color: white;
        }
    </style>
</head>
<body>
<div class="title">
    <div class="imgage">
        <!--<img src="images/wei.png">-->
        <span></span>
        <a href="search1.html">
            <div class="search" id="search_bar">
                <!--                <form class="weui-search-bar__form">-->
                <!--                    <div class="weui-search-bar__box">-->
                <!--                        <i class="weui-icon-search"></i>-->
                <!--                        <input type="search" class="weui-search-bar__input" id="search_input" placeholder="搜索"/>-->
                <!--                    </div>-->
                <!--                </form>-->
            </div>
        </a>
        <img class="head user-img" src="images/head.png">
        <a href="messagenotification.html">
            <div class="alarm">
                <img src="images/message.png">
                <div class="right"></div>
            </div>
        </a>
    </div>
    <div>
        <div class="swiper-container">
            <div class="swiper-wrapper sw">
            </div>
        </div>
    </div>
</div>
<div class="best">
    <!-- 近期热卖 -->
    <div class="biaoti">近期热卖</div>
    <div class="sale_com"></div>
    <div class="refresh" style="cursor: pointer">
        <img src="images/huan.png">
        <!--<div>-->
        <!--<button class="wx-pay">测试支付</button>-->
        <!--</div>-->
        <div class="refresh-tt">换一批</div>
    </div>
</div>

<!--为你推荐 -->
<!--<div class="recommend">
    <div class="biaoti">为你推荐</div>
    <div class="recommend-list">

    </div>
</div>-->
<div class="cov">
    <div class="con">
        <div class="ptitle"><img src="images/cover.png"></div>
        <div class="text">购买商品前请先完善个人信息</div>
        <div class="button">
            <div onclick="closeCon();" class="dbt">暂时忽略</div>
            <div class="but"><a href="information.html">立即完善</a></div>
        </div>
    </div>
</div>
<!--<button onclick="showCon();">xxxxxx</button>-->
<script>
    menu_index = 1;
</script>
<script src="../lib/jquery-2.1.4.js"></script>
<script src="../lib/fastclick.js"></script>
<script src="../lib/common.js"></script>
<script src="../lib/layer.js"></script>
<script>
    $(function () {
        FastClick.attach(document.body);
    });
</script>
<script src="../js/jquery-weui.js"></script>

<style>
    .weui-tabbar__icon {
        width: 20px;
        height: 20px;
    }

    .weui-tabbar__label {
        font-size: 13px;
        color: #000000;
    }

    .weui-tabbar {
        background-color: #FFFFFF;
        position: fixed;
    }
</style>
<div class="">
    <div class="weui-tabbar">
    </div>
</div>

<script>

    var total = 0;
    var index = 1;

    function get_commodity(page_num) {
        page_num = page_num || 1;
        var params = {
            offline: false,
            type: 'ct_sale'
        };
        var page = '&page=' + page_num + '&max_results=10';
        var embedded = {
            imgs: true,
            spec: true
        };
        var sorts = 'monthly_sales';
        sendAjax('api/commodity?where=' + JSON.stringify(params) + '&embedded=' + JSON.stringify(embedded) + '&sort=' + sorts + page, '', 'GET', function (resp) {
            var data = resp._items.filter(function (val) {
                if (!val.user_type) return true;
                var utype = val.user_type.split(',');
                return $.inArray(sessionStorage.getItem('user_type'), utype) > -1
            });
            total = resp._meta.total;
            var sale_html = '';
            var b_img_html = '';

            if (data.length) {
                data.forEach(function (val, index) {
                    // 首页轮播
                    var b_img = filter_val(val.imgs, 'is_desc', true, 'url');
                    if (index < 3 && b_img) {
                        b_img_html += '<div class="swiper-slide"><img src="' + _BASE_API + b_img + '"/></div>'
                    }

                    // 近期热卖商品
                    var img = filter_val(val.imgs, 'is_desc', false, 'url');
                    sale_html += '<div>';
                    sale_html += '<div class="details">';

                    sale_html += '<div class="details-left"><a href="commoditydetails.html?id=' + val.id + '">';
                    if (img) {
                        sale_html += '<img src="' + _BASE_API + img + '">';
                    } else {
                        sale_html += '<span></span>';
                    }
                    sale_html += '</a></div>';
                    sale_html += '<div class="details-right">';
                    sale_html += '<div class="right-name">' + val.name + '</div>';
                    sale_html += '<div class="right-price">';
                    sale_html += '<div class="pric"><p class="yuan">¥' + (val.spec.length ? (val.spec[0].price * sessionStorage.getItem('discount')).toFixed(2) : '--') + '</p>';
                    //sale_html += '<p class="xiao">月销' + (val.monthly_sales || 0) + '</p></div>';
                    sale_html += '<a href="commoditydetails.html?id=' + val.id + '"><div class="num">立即购买</div></a>';
                    sale_html += '</div>';
                    sale_html += '</div>';
                    sale_html += '</div>';
                    sale_html += '</div>';
                })
            }
            $('.sw').html(b_img_html);
            $('.sale_com').html(sale_html);
        })
    }

    get_commodity();

    $('.refresh').click(function () {
        var pn = Math.ceil(total / 10);
        index++;
        if (index <= pn) {
            get_commodity(index);
        } else {
            get_commodity();
            index = 1;
        }

    });

    function get_order() {
        // to_pay = '待支付'
        // to_deliver = '待发货'
        // is_deliver = '待收货'
        // delivered = '已签收'
        // is_refund = '退款申请'
        // refunded = '退款完成'
        var params = {
            status: ['to_pay', 'to_deliver', 'is_deliver', 'is_refund'],
            is_deleted: false,
        };
        sendAjax('api/order?where=' + JSON.stringify(params), '', 'get', function (resp) {
            var order_len = resp._items.length;
            if (order_len) {
                $('.alarm .right').show()
            } else {
                $('.alarm .right').hide()
            }
            $('.alarm .right').text(order_len)
        })
    }

    get_order();

    $('.wx-pay').click(function () {
        var data = {
            user_id: sessionStorage.getItem('user_id')
        };
        sendAjax('api/tx/pay', data, 'POST', function (resp) {
            var appId = resp.appId;
            var nonceStr = resp.nonceStr;
            var timeStamp = resp.timeStamp;
            var _package = resp.package;
            var signType = resp.signType;
            var paySign = resp.sign;

            if (typeof WeixinJSBridge === "undefined") {
                if (document.addEventListener) {
                    document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                } else if (document.attachEvent) {
                    document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                    document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                }
            } else {
                onBridgeReady(appId, timeStamp, nonceStr, _package, signType, paySign)
            }


        })
    })

</script>

<script>

    var menu_list = [
        {
            'id': 1,
            'name': '首页',
            'orgin_path': 'images/shouye.png',
            'select_path': 'images/me.png',
            'src': 'home.html'
        },
        {
            'id': 2,
            'name': '分类',
            'orgin_path': 'images/fenlei.png',
            'select_path': 'images/me.png',
            'src': 'classification.html'
        },
        {
            'id': 3,
            'name': '购物车',
            'orgin_path': 'images/gouwuche.png',
            'select_path': 'images/me.png',
            'src': 'shoppingcartnone.html'
        },
        {
            'id': 4,
            'name': '我的',
            'orgin_path': 'images/me.png',
            'select_path': 'images/me.png',
            'src': 'person.html'
        },
    ];
    $(function () {
        var html = '';
        $.each(menu_list, function (k, v) {
            html += '<a href="' + v.src + '" class="weui-tabbar__item" data-src="' + v.src + '">'
            if (v.id == menu_index) {
                html += '<img src="' + v.select_path + '" alt="" class="weui-tabbar__icon">'
            } else {
                html += '<img src="' + v.orgin_path + '" alt="" class="weui-tabbar__icon">'
            }
            html += '<p class="weui-tabbar__label">' + v.name + '</p>'
            html += '</a>';
        });
        $('.weui-tabbar').html('');
        $('.weui-tabbar').html(html);
    })

</script>
<script>
    $(document).ready(function () {
        sendAjax('api/user_profit', '', 'get', function (resp) {
            var info = resp._items.filter(function (val) {
                return val.type === type
            });
            if (info.length) {
                sessionStorage.setItem('discount', info[0].discount / 100)
            } else {
                sessionStorage.setItem('discount', 1)
            }
        });

        sendAjax('api/user/' + sessionStorage.getItem('user_id'), '', 'GET', function (resp) {
            if (resp.img_url)
                $('.user-img').attr('src', _BASE_API + resp.img_url)
        })
    })
</script>
<script src="../js/swiper.js"></script>
<script>
    $(".swiper-container").swiper({
        loop: true,
        autoplay: 3000
    });

    function showCon() {
        $(".cov").show();
    }

    function closeCon() {
        $(".cov").hide();
    }
</script>
</body>
</html>
